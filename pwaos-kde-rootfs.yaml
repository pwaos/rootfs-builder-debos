{{- $image := or .image "pwaos-kde-rootfs.img" -}}

architecture: arm64

actions:
  - action: recipe
    description: Setup Gemian rootfs
    recipe: pwaos-common.yaml

 - action: apt
    description: Installing packages for libhybris-based HW adaptation
    packages:
      - audiosystem-passthrough
      - dialer-app
      - drihybris
      - gemian-lock
      - glamor-hybris
      - libhybris
      - messaging-app
      - ofono
      - ofono-ril-binder-plugin
      - pulseaudio
      - pulseaudio-module-droid
      - pulseaudio-module-droid-hidl
      - repowerd
      - urfkill
      - xkb-data
      - xserver-xorg-video-hwcomposer
      - xss-lock

  - action: run
    chroot: true
    description: Enabling libhybris EGL libs
    command: ln -s /usr/lib/aarch64-linux-gnu/libhybris-egl/ld.so.conf /etc/ld.so.conf.d/00_libhybris-egl.conf && ldconfig

  - action: run
    chroot: true
    description: Applying custom PulseAudio config
    command: ln -sf default.pa.gemian /etc/pulse/default.pa

  - action: run
    chroot: true
    description: Fix default DPI
    command: sed -e "s@\\[server\\]@[server]\\narg=/usr/bin/Xorg -dpi 192\n@" -i /etc/lxdm/lxdm.conf

  - action: image-file
    imagename: {{ $image }}
    imagesize: 4GB
    fs: ext4
    fsname: "pwaos"

  - action: filesystem-deploy
    setup-fstab: false
    setup-kernel-cmdline: false
    description: Deploying filesystem onto image