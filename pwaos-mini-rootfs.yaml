{{- $image := or .image "pwaos-mini-rootfs.img" -}}

architecture: arm64

actions:
  - action: debootstrap
    suite: "buster"
    components:
      - main
      - non-free
    mirror: https://deb.debian.org/debian

  - action: apt
    description: Installing additional Debian packages
    packages: [ curl, gnupg, net-tools,openssh-server, sudo, psmisc, vim]

  - action: run
    chroot: true
    description: Adding Gemian repos
    script: scripts/add-gemian-repos.sh

  - action: apt
    description: Installing packages for libhybris-based HW adaptation
    packages:
      - hybris-usb
      - droid-hal-cosmopda

  - action: run
    chroot: true
    description: Enabling USB networking service && remove droid-hal-cosmopda
    command: systemctl enable usb-tethering && apt remove droid-hal-cosmopda

  - action: run
    chroot: true
    description: Setting Gemian users
    script: scripts/setup-user.sh

  - action: run
    chroot: true
    command: echo cosmopda > /etc/hostname

  - action: run
    chroot: true
    description: Setting password on root user (useful for testing, remove later)
    command: echo root:root | chpasswd

  - action: run
    chroot: true
    description: Add apt sandbox user to Android inet group
    command: sed -i 's/_apt:x:100:65534/_apt:x:100:3003/g' /etc/passwd

  - action: apt
    description: Installing packages for lxc
    packages:
      - lxc
      - lxc-android

  - action: run
    chroot: true
    description: Setup lxc env
    script: scripts/setup-lxc.sh

  - action: overlay
    description: Adding pwaos overlay
    source: overlay/pwaos
    destination: /

  - action: image-file
    imagename: {{ $image }}
    imagesize: 4GB
    fs: ext4
    fsname: "pwaos"

  - action: filesystem-deploy
    setup-fstab: false
    setup-kernel-cmdline: false
    description: Deploying filesystem onto image
