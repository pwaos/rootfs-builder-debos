architecture: arm64

actions:
  - action: debootstrap
    suite: "buster"
    components:
      - main
      - non-free
    mirror: https://deb.debian.org/debian

  - action: apt
    description: Installing additional Debian packages
    packages: [ curl, gnupg, net-tools,openssh-server, sudo, psmisc, vim]

  - action: run
    chroot: true
    description: Adding Gemian repos
    script: scripts/add-gemian-repos.sh

  - action: apt
    description: Installing packages for USB networking service
    packages:
      - hybris-usb
      - droid-hal-cosmopda

  - action: run
    chroot: true
    description: Enabling USB networking service && remove droid-hal-cosmopda
    command: systemctl enable usb-tethering && apt -y remove droid-hal-cosmopda

  - action: run
    chroot: true
    description: Setting Gemian users
    script: scripts/setup-user.sh

  - action: run
    chroot: true
    command: echo cosmopda > /etc/hostname

  - action: run
    chroot: true
    description: Setting password on root user (useful for testing, remove later)
    command: echo root:root | chpasswd

  - action: run
    chroot: true
    description: Add apt sandbox user to Android inet group
    command: sed -i 's/_apt:x:100:65534/_apt:x:100:3003/g' /etc/passwd

  - action: apt
    description: Installing packages for lxc
    packages:
      - lxc
      - lxc-android

  - action: overlay
    description: Adding pwaos-lxc overlay 1
    source: overlay/lxc-setup
    destination: /

  - action: run
    chroot: true
    description: Setup lxc env 2
    command: systemctl unmask droid-hal-init

  - action: run
    chroot: true
    description: create lxc dir 3
    command: mkdir -p /var/lib/lxc-android-config/diversions && mkdir -p /var/lib/lxc/android/overrides && mkdir -p /var/lib/lxc/android/rootfs

  - action: run
    chroot: true
    description: create lxc symbollink 4
    command: mkdir -p /android /mnt/vendor/persist /mnt/vendor/efs /userdata && ln -s /android/data /data && ln -s /android/system /system && ln -s /android/vendor /vendor && ln -s /android/cache /cache && ln -s /android/persist /persist && ln -s /android/product /product && ln -s /android/metadata /metadata && ln -s /android/efs /efs

  - action: overlay
    description: Adding pwaos overlay
    source: overlay/pwaos
    destination: /